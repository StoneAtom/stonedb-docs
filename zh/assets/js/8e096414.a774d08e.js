"use strict";(self.webpackChunkstoneDB=self.webpackChunkstoneDB||[]).push([[1185],{3905:function(e,n,s){s.d(n,{Zo:function(){return m},kt:function(){return c}});var t=s(67294);function r(e,n,s){return n in e?Object.defineProperty(e,n,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[n]=s,e}function l(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),s.push.apply(s,t)}return s}function a(e){for(var n=1;n<arguments.length;n++){var s=null!=arguments[n]?arguments[n]:{};n%2?l(Object(s),!0).forEach((function(n){r(e,n,s[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))}))}return e}function o(e,n){if(null==e)return{};var s,t,r=function(e,n){if(null==e)return{};var s,t,r={},l=Object.keys(e);for(t=0;t<l.length;t++)s=l[t],n.indexOf(s)>=0||(r[s]=e[s]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(t=0;t<l.length;t++)s=l[t],n.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(e,s)&&(r[s]=e[s])}return r}var i=t.createContext({}),_=function(e){var n=t.useContext(i),s=n;return e&&(s="function"==typeof e?e(n):a(a({},n),e)),s},m=function(e){var n=_(e.components);return t.createElement(i.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},y=t.forwardRef((function(e,n){var s=e.components,r=e.mdxType,l=e.originalType,i=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),y=_(s),c=r,p=y["".concat(i,".").concat(c)]||y[c]||u[c]||l;return s?t.createElement(p,a(a({ref:n},m),{},{components:s})):t.createElement(p,a({ref:n},m))}));function c(e,n){var s=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=s.length,a=new Array(l);a[0]=y;var o={};for(var i in n)hasOwnProperty.call(n,i)&&(o[i]=n[i]);o.originalType=e,o.mdxType="string"==typeof e?e:r,a[1]=o;for(var _=2;_<l;_++)a[_]=s[_];return t.createElement.apply(null,a)}return t.createElement.apply(null,s)}y.displayName="MDXCreateElement"},57982:function(e,n,s){s.r(n),s.d(n,{assets:function(){return m},contentTitle:function(){return i},default:function(){return c},frontMatter:function(){return o},metadata:function(){return _},toc:function(){return u}});var t=s(87462),r=s(63366),l=(s(67294),s(3905)),a=["components"],o={id:"read_write-splitting",sidebar_position:7.51},i="\u8bfb\u5199\u5206\u79bb",_={unversionedId:"performance-tuning/architecture-tuning/read_write-splitting",id:"performance-tuning/architecture-tuning/read_write-splitting",title:"\u8bfb\u5199\u5206\u79bb",description:"\u4e00\u3001ProxySQL\u4ecb\u7ecd",source:"@site/i18n/zh/docusaurus-plugin-content-docs/current/06-performance-tuning/05-architecture-tuning/read_write-splitting.md",sourceDirName:"06-performance-tuning/05-architecture-tuning",slug:"/performance-tuning/architecture-tuning/read_write-splitting",permalink:"/zh/docs/performance-tuning/architecture-tuning/read_write-splitting",draft:!1,editUrl:"https://github.com/stoneatom/stonedb/edit/stonedb-5.7/website/i18n/zh/docusaurus-plugin-content-docs/current/06-performance-tuning/05-architecture-tuning/read_write-splitting.md",tags:[],version:"current",lastUpdatedBy:"hustjieke",lastUpdatedAt:1659496788,formattedLastUpdatedAt:"2022/8/3",sidebarPosition:7.51,frontMatter:{id:"read_write-splitting",sidebar_position:7.51},sidebar:"autoSidebar",previous:{title:"\u6570\u636e\u5e93\u53c2\u6570\u4f18\u5316",permalink:"/zh/docs/performance-tuning/database-tuning/parameter-tuning"},next:{title:"StoneDB\u6027\u80fd\u6d4b\u8bd5\u65b9\u6cd5\uff08OLAP\uff09",permalink:"/zh/docs/performance-tuning/performance-tests/OLAP/olap-performance-test-method"}},m={},u=[{value:"\u4e00\u3001ProxySQL\u4ecb\u7ecd",id:"\u4e00proxysql\u4ecb\u7ecd",level:2},{value:"\u4e8c\u3001ProxySQL\u67b6\u6784",id:"\u4e8cproxysql\u67b6\u6784",level:2},{value:"\u4e09\u3001ProxySQL\u7cfb\u7edf\u8868\u53ca\u914d\u7f6e\u8be6\u89e3",id:"\u4e09proxysql\u7cfb\u7edf\u8868\u53ca\u914d\u7f6e\u8be6\u89e3",level:2},{value:"3.1 ProxySQL\u7aef\u53e3\u8bf4\u660e",id:"31-proxysql\u7aef\u53e3\u8bf4\u660e",level:3},{value:"3.2 ProxySQL\u7ba1\u7406\u7aef\u914d\u7f6e\u6570\u636e\u5e93",id:"32-proxysql\u7ba1\u7406\u7aef\u914d\u7f6e\u6570\u636e\u5e93",level:3},{value:"3.3 ProxySQL\u7ba1\u7406\u7aef\u6570\u636e\u5e93\u8bf4\u660e",id:"33-proxysql\u7ba1\u7406\u7aef\u6570\u636e\u5e93\u8bf4\u660e",level:3},{value:"\u56db\u3001\u5b89\u88c5",id:"\u56db\u5b89\u88c5",level:2},{value:"4.1 \u4e0b\u8f7dProxySQL",id:"41-\u4e0b\u8f7dproxysql",level:3},{value:"4.2 \u4fee\u6539proxysql.cnf \u914d\u7f6e",id:"42-\u4fee\u6539proxysqlcnf-\u914d\u7f6e",level:3},{value:"4.3 \u521b\u5efaStoneDB\u8d26\u53f7",id:"43-\u521b\u5efastonedb\u8d26\u53f7",level:3},{value:"4.4 \u914d\u7f6eProxySQL",id:"44-\u914d\u7f6eproxysql",level:3},{value:"4.5\u6d4b\u8bd5\u8bfb\u5199\u5206\u79bb\u89c4\u5219",id:"45\u6d4b\u8bd5\u8bfb\u5199\u5206\u79bb\u89c4\u5219",level:3},{value:"\u4e94\u3001\u6269\u5c55\u77e5\u8bc6",id:"\u4e94\u6269\u5c55\u77e5\u8bc6",level:2}],y={toc:u};function c(e){var n=e.components,o=(0,r.Z)(e,a);return(0,l.kt)("wrapper",(0,t.Z)({},y,o,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"\u8bfb\u5199\u5206\u79bb"},"\u8bfb\u5199\u5206\u79bb"),(0,l.kt)("h2",{id:"\u4e00proxysql\u4ecb\u7ecd"},"\u4e00\u3001ProxySQL\u4ecb\u7ecd"),(0,l.kt)("p",null,"ProxySQL\u662f\u4e00\u6b3e\u5f00\u6e90\u7684\u4e2d\u95f4\u4ef6\u4ea7\u54c1\uff0c\u662f\u4e00\u4e2a\u7075\u6d3b\u7684\u4ee3\u7406\u5c42\uff0c\u53ef\u4ee5\u5b9e\u73b0\u8bfb\u5199\u5206\u79bb\uff0c\u652f\u6301Query\u8def\u7531\u529f\u80fd\uff0c\u652f\u6301\u52a8\u6001\u6307\u5b9a\u67d0\u4e2aSQL\u8fdb\u884c\u7f13\u5b58\uff0c\u652f\u6301\u52a8\u6001\u52a0\u8f7d\uff08\u65e0\u9700\u91cd\u542fProxySQL\u670d\u52a1\uff09\uff0c\u6545\u969c\u5207\u6362\u548c\u4e00\u4e9bSQL\u7684\u8fc7\u6ee4\u529f\u80fd\u3002\n\u76f8\u5173ProxySQL\u7684\u7f51\u7ad9\n",(0,l.kt)("a",{parentName:"p",href:"https://www.proxysql.com/"},"https://www.proxysql.com/"),"\n",(0,l.kt)("a",{parentName:"p",href:"https://github.com/sysown/proxysql/wiki"},"https://github.com/sysown/proxysql/wiki")),(0,l.kt)("h2",{id:"\u4e8cproxysql\u67b6\u6784"},"\u4e8c\u3001ProxySQL\u67b6\u6784"),(0,l.kt)("p",null,(0,l.kt)("img",{src:s(55419).Z,width:"525",height:"1054"})),(0,l.kt)("h2",{id:"\u4e09proxysql\u7cfb\u7edf\u8868\u53ca\u914d\u7f6e\u8be6\u89e3"},"\u4e09\u3001ProxySQL\u7cfb\u7edf\u8868\u53ca\u914d\u7f6e\u8be6\u89e3"),(0,l.kt)("h3",{id:"31-proxysql\u7aef\u53e3\u8bf4\u660e"},"3.1 ProxySQL\u7aef\u53e3\u8bf4\u660e"),(0,l.kt)("p",null,"ProxySQL\u5b89\u88c5\u90e8\u7f72\u5b8c\u6210\u540e\u6709\u4ee5\u4e0b\u4e24\u4e2a\u7aef\u53e3\uff1a\n6032\u662f\u7ba1\u7406\u7aef\u53e3\uff0c\u53ef\u4ee5\u4f7f\u7528admin/admin\u8d26\u53f7\u5bc6\u7801\u767b\u5f55\u4fee\u6539\u7cfb\u7edf\u914d\u7f6e\uff0cadmin\u8d26\u53f7\u53ea\u5141\u8bb8\u672c\u5730\u767b\u5f55\uff0c\u8fdc\u7a0b\u767b\u5f55\u9700\u8981\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u8fdc\u7a0b\u767b\u5f55\u8d26\u53f7\uff0c\u914d\u7f6e\u8fdc\u7a0b\u767b\u5f55\u8d26\u53f7\u6700\u597d\u5728\u90e8\u7f72\u542f\u52a8\u524d\u914d\u7f6e\uff0c\u8fc7\u540e\u914d\u7f6e\u9700\u8981\u6e05\u7a7a\u6570\u636e\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6570\u636e\u6587\u4ef6\uff0c\u91cd\u65b0\u521d\u59cb\u5316\u3002\n6033\u662f\u5ba2\u6237\u7aef\u63a5\u53e3\u7aef\u53e3\uff0c\u767b\u5f55\u8d26\u53f7\u5bc6\u7801\u7531\u540e\u7aef\u6570\u636e\u5e93\u8bbe\u7f6e\u540e\uff0c\u518d\u4f7f\u75286032\u7ba1\u7406\u7aef\u53e3\u767b\u5f55\u914d\u7f6emysql_users\u540e\uff0c\u518d\u5237\u65b0\u8d26\u6237\u914d\u7f6e\u3002"),(0,l.kt)("h3",{id:"32-proxysql\u7ba1\u7406\u7aef\u914d\u7f6e\u6570\u636e\u5e93"},"3.2 ProxySQL\u7ba1\u7406\u7aef\u914d\u7f6e\u6570\u636e\u5e93"),(0,l.kt)("p",null,"ProxySQL\u6709\u4e24\u79cd\u914d\u7f6e\u540e\u7aef\u6570\u636e\u5e93\u7684\u65b9\u6cd5\uff0c\u4e00\u79cd\u662f\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u914d\u7f6e\uff0c\u914d\u7f6e\u540e\u542f\u52a8\u521d\u59cb\u5316ProxySQL\u81ea\u52a8\u751f\u6210\u914d\u7f6e\uff0c\u4e0d\u5efa\u8bae\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u8fdb\u884c\u914d\u7f6e\uff0c\u53e6\u4e00\u79cd\u662f\u901a\u8fc7\u767b\u5f55\u7ba1\u7406\u7aef\u8fdb\u884c\u5728\u7ebf\u4fee\u6539\u914d\u7f6e\uff0c\u4fee\u6539\u540e\u901a\u8fc7\u52a0\u8f7d\u8fd0\u884c\u548c\u5237\u76d8\u914d\u7f6e\u5230\u78c1\u76d8\u7684\u547d\u4ee4\u505a\u6301\u4e45\u5316\u4fdd\u5b58\uff0c\u8fd9\u79cd\u65b9\u6cd5\u65e0\u9700\u91cd\u542f\uff0c\u914d\u7f6e\u540e\u52a0\u8f7d\u8fd0\u884c\u5373\u53ef\u751f\u6548\u3002"),(0,l.kt)("h3",{id:"33-proxysql\u7ba1\u7406\u7aef\u6570\u636e\u5e93\u8bf4\u660e"},"3.3 ProxySQL\u7ba1\u7406\u7aef\u6570\u636e\u5e93\u8bf4\u660e"),(0,l.kt)("p",null,"\u6211\u4eec\u901a\u8fc7\u7ba1\u7406\u7aef\u53e36032\u767b\u5f55\u5230\u7ba1\u7406\u7aef\u540e\u6267\u884cshow databases\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u7ed3\u679c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"ProxySQL proxy>show databases;\n+-----+---------------+-------------------------------------+\n| seq | name          | file                                |\n+-----+---------------+-------------------------------------+\n| 0   | main          |                                     |\n| 2   | disk          | /var/lib/proxysql/proxysql.db       |\n| 3   | stats         |                                     |\n| 4   | monitor       |                                     |\n| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |\n+-----+---------------+-------------------------------------+\n5 rows in set (0.00 sec)\n\n")),(0,l.kt)("p",null,"\u5e93\u8bf4\u660e\uff1a\nmain \u5e93\u5185\u7f6e\u914d\u7f6e\u6570\u636e\u5e93\uff0c\u8868\u5b58\u653e\u540e\u7aefdb\u5b9e\u4f8b\u3001\u7528\u6237\u9a8c\u8bc1\u3001\u8def\u7531\u89c4\u5219\u7b49\u4fe1\u606f\uff0c\u8868\u540d\u4ee5runtime \u5f00\u5934\u7684\u8868\u793aProxySQL\u5f53\u524d\u8fd0\u884c\u7684\u914d\u7f6e\u5185\u5bb9\uff0c\u4e0d\u80fd\u901a\u8fc7dml\u8bed\u53e5\u4fee\u6539\uff0c\u53ea\u80fd\u4fee\u6539\u5bf9\u5e94\u7684\u4e0d\u4ee5 runtime \u5f00\u5934\u7684\uff08\u5728\u5185\u5b58\uff09\u91cc\u7684\u8868\uff0c\u7136\u540e LOAD \u4f7f\u5176\u751f\u6548\uff0c SAVE \u4f7f\u5176\u5b58\u5230\u786c\u76d8\u4ee5\u4f9b\u4e0b\u6b21\u91cd\u542f\u52a0\u8f7d\u3002\ndisk \u662f\u6301\u4e45\u5316\u5230\u786c\u76d8\u7684\u914d\u7f6e\uff0csqlite\u6570\u636e\u6587\u4ef6\uff0c\u907f\u514dProxySQL\u91cd\u542f\u5bfc\u81f4\u914d\u7f6e\u6587\u4ef6\u4e22\u5931\nstats \u662fProxySQL\u8fd0\u884c\u6293\u53d6\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u5305\u62ec\u5230\u540e\u7aef\u5404\u547d\u4ee4\u7684\u6267\u884c\u6b21\u6570\u3001\u6d41\u91cf\u3001processlist\u3001\u67e5\u8be2\u79cd\u7c7b\u6c47\u603b/\u6267\u884c\u65f6\u95f4\u7b49\u7b49\u3002\nmonitor \u5e93\u5b58\u50a8 monitor \u6a21\u5757\u6536\u96c6\u7684\u4fe1\u606f\uff0c\u4e3b\u8981\u662f\u5bf9\u540e\u7aefdb\u7684\u5065\u5eb7/\u5ef6\u8fdf\u68c0\u67e5\u3002\nstats_history \u7edf\u8ba1\u4fe1\u606f\u5386\u53f2\u5e93"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"ProxySQL proxy>show tables from main;\n+----------------------------------------------------+\n| tables                                             |\n+----------------------------------------------------+\n| global_variables                                   |# ProxySQL\u7684\u57fa\u672c\u914d\u7f6e\u53c2\u6570\uff0c\u7c7b\u4f3c\u4e0eMySQL\n| mysql_aws_aurora_hostgroups                        |\n| mysql_collations                                   |# \u914d\u7f6e\u5bf9MySQL\u5b57\u7b26\u96c6\u7684\u652f\u6301\n| mysql_firewall_whitelist_rules                     |\n| mysql_firewall_whitelist_sqli_fingerprints         |\n| mysql_firewall_whitelist_users                     |\n| mysql_galera_hostgroups                            |\n| mysql_group_replication_hostgroups                 | # MGR\u76f8\u5173\u7684\u8868\uff0c\u7528\u4e8e\u5b9e\u4f8b\u7684\u8bfb\u5199\u7ec4\u81ea\u52a8\u5206\u914d\n| mysql_query_rules                                  | # \u8def\u7531\u8868\n| mysql_query_rules_fast_routing                     | # \u4e3b\u4ece\u590d\u5236\u76f8\u5173\u7684\u8868\uff0c\u7528\u4e8e\u5b9e\u4f8b\u7684\u8bfb\u5199\u7ec4\u81ea\u52a8\u5206\u914d\n| mysql_replication_hostgroups                       | # \u5b58\u50a8MySQL\u5b9e\u4f8b\u7684\u4fe1\u606f\n| mysql_servers                                      | # \u73b0\u9636\u6bb5\u5b58\u50a8MySQL\u7528\u6237\uff0c\u5f53\u7136\u4ee5\u540e\u6709\u524d\u540e\u7aef\u8d26\u53f7\u5206\u79bb\u7684\u8bbe\u60f3\n| mysql_users                                        | # \u5b58\u50a8ProxySQL\u7684\u4fe1\u606f\uff0c\u7528\u4e8eProxySQL Cluster\u540c\u6b65\n| proxysql_servers                                   | \n| restapi_routes                                     |\n| runtime_checksums_values                           |\n| runtime_global_variables                           |\n| runtime_mysql_aws_aurora_hostgroups                |\n| runtime_mysql_firewall_whitelist_rules             |\n| runtime_mysql_firewall_whitelist_sqli_fingerprints |\n| runtime_mysql_firewall_whitelist_users             |\n| runtime_mysql_galera_hostgroups                    |\n| runtime_mysql_group_replication_hostgroups         | # \u4e0e\u4e0a\u9762\u5bf9\u5e94\uff0c\u4f46\u662f\u8fd0\u884c\u73af\u5883\u6b63\u5728\u4f7f\u7528\u7684\u914d\u7f6e\n| runtime_mysql_query_rules                          |\n| runtime_mysql_query_rules_fast_routing             |\n| runtime_mysql_replication_hostgroups               |\n| runtime_mysql_servers                              |\n| runtime_mysql_users                                |\n| runtime_proxysql_servers                           |\n| runtime_restapi_routes                             |\n| runtime_scheduler                                  |\n| scheduler                                          |\n+----------------------------------------------------+\n32 rows in set (0.00 sec)\n\n# runtime_\u5f00\u5934\u7684\u662f\u8fd0\u884c\u65f6\u7684\u914d\u7f6e\uff0c\u8fd9\u4e9b\u662f\u4e0d\u80fd\u4fee\u6539\u7684\u3002\u8981\u4fee\u6539ProxySQL\u7684\u914d\u7f6e\uff0c\u9700\u8981\u4fee\u6539\u4e86\u975eruntime_\u8868\uff0c\u4fee\u6539\u540e\u5fc5\u987b\u6267\u884cLOAD ... \n# TO RUNTIME\u624d\u80fd\u52a0\u8f7d\u5230RUNTIME\u751f\u6548\uff0c\u6267\u884csave ... to disk\u624d\u80fd\u5c06\u914d\u7f6e\u6301\u4e45\u5316\u4fdd\u5b58\u5230\u78c1\u76d8\u3002\n\n")),(0,l.kt)("h2",{id:"\u56db\u5b89\u88c5"},"\u56db\u3001\u5b89\u88c5"),(0,l.kt)("h3",{id:"41-\u4e0b\u8f7dproxysql"},"4.1 \u4e0b\u8f7dProxySQL"),(0,l.kt)("p",null,"\u5b98\u7f51\u4e0b\u8f7drpm\u5305\u5b89\u88c5\uff0c\u4e0b\u8f7d\u540e\u6267\u884c\u5b89\u88c5\uff08yum\u5b89\u88c5\u53ef\u4ee5\u89e3\u51b3\u4f9d\u8d56\u95ee\u9898\nProxySQL\u5b98\u7f51:",(0,l.kt)("a",{parentName:"p",href:"https://proxysql.com/documentation/installing-proxysql/"},"https://proxysql.com/documentation/installing-proxysql/")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"[root@Proxysql ~]# wget https://github.com/sysown/proxysql/releases/download/v2.4.1/proxysql-2.4.1-1-centos7.x86_64.rpm\n[root@Proxysql ~]# yum install proxysql-2.4.1-1-centos7.x86_64.rpm -y\n\n\n[root@Proxysql ~]# systemctl start proxysql\n\n[root@Proxysql ~]# systemctl enable proxysql\n\n[root@Proxysql ~]# ss -lntup|grep proxy\n")),(0,l.kt)("h3",{id:"42-\u4fee\u6539proxysqlcnf-\u914d\u7f6e"},"4.2 \u4fee\u6539proxysql.cnf \u914d\u7f6e"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[root@Proxysql ~]# vim /etc/proxysql.cnf\nadmin_variables=\n{\n#       admin_credentials="radmin:radmin"\n        admin_credentials="admin:admin;radmin:radmin"\n#\u4e3b\u8981\u4fee\u6539\u4ee5\u4e0a\u914d\u7f6e\uff0c\u5176\u4ed6\u914d\u7f6e\u540e\u9762\u542f\u52a8proxysql \u540e\u767b\u5f55\u7ba1\u7406\u7aef\u518d\u4fee\u6539\u66f4\u65b9\u4fbf\n')),(0,l.kt)("h3",{id:"43-\u521b\u5efastonedb\u8d26\u53f7"},"4.3 \u521b\u5efaStoneDB\u8d26\u53f7"),(0,l.kt)("p",null,"\u521b\u5efaProxySQL\u76d1\u63a7StoneDB\u8d26\u6237\uff0c\u8fd8\u6709\u4e1a\u52a1\u670d\u52a1\u8bbf\u95ee\u8d26\u6237\uff08StoneDB\u505a\u4e86\u4e3b\u4ece\u67b6\u6784\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u5728\u4e3b\u5e93\u4e0a\u6267\u884c\u521b\u5efa\u8d26\u53f7\u5373\u53ef\uff09"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# proxysql\u76d1\u63a7\u8d26\u53f7\nmysql>  GRANT ALL ON * . * TO  'proxysql'@'%' identified by 'xxxxxxx'; #\u7528\u4e8eproxysql\u76d1\u63a7StoneDB\u6743\u9650\u53ef\u4ee5\u7f29\u5c0f\u70b9\uff0c\u540e\u671f\u6d4b\u8bd5\u4e0b\u8865\u5145\u4e0b\u7f29\u5c0f\u7684\u6743\u9650\n# \u521b\u5efa\u4e1a\u52a1\u4f7f\u7528\u8d26\u53f7\nmysql> GRANT ALL ON * . * TO  'zz'@'%' identified by 'xxxxxxx';\n")),(0,l.kt)("h3",{id:"44-\u914d\u7f6eproxysql"},"4.4 \u914d\u7f6eProxySQL"),(0,l.kt)("p",null,"\u767b\u5f55ProxySQL 6032\u7aef\u53e3\u8fdb\u884c\u914d\u7f6e\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@docker ~]# mysql -h192.168.46.30 -uradmin -pradmin -P16032\n\nmysql> select * from global_variables;\n+----------------------------------------------------------------------+-----------------------------+\n| variable_name                                                        | variable_value              |\n+----------------------------------------------------------------------+-----------------------------+\n| mysql-default_charset                                                | utf8                        |\n| mysql-default_collation_connection                                   | utf8_general_ci             |\n| mysql-shun_on_failures                                               | 5                           |\n| mysql-shun_recovery_time_sec                                         | 10                          |\n| mysql-query_retries_on_failure                                       | 1                           |\n| mysql-client_multi_statements                                        | true                        |\n| mysql-client_host_cache_size                                         | 0                           |\n| mysql-client_host_error_counts                                       | 0                           |\n| mysql-connect_retries_delay                                          | 1                           |\n| mysql-connection_delay_multiplex_ms                                  | 0                           |\n| mysql-connection_max_age_ms                                          | 0                           |\n| mysql-connect_timeout_client                                         | 10000                       |\n| mysql-connect_timeout_server_max                                     | 10000                       |\n| mysql-enable_client_deprecate_eof                                    | true                        |\n| mysql-enable_server_deprecate_eof                                    | true                        |\n| mysql-enable_load_data_local_infile                                  | false                       |\n| mysql-eventslog_filename                                             |                             |\n| mysql-eventslog_filesize                                             | 104857600                   |\n| mysql-eventslog_default_log                                          | 0                           |\n| mysql-eventslog_format                                               | 1                           |\n| mysql-auditlog_filename                                              |                             |\n| mysql-auditlog_filesize                                              | 104857600                   |\n| mysql-handle_unknown_charset                                         | 1                           |\n| mysql-free_connections_pct                                           | 10                          |\n| mysql-connection_warming                                             | false                       |\n| mysql-session_idle_ms                                                | 1                           |\n| mysql-have_ssl                                                       | false                       |\n| mysql-client_found_rows                                              | true                        |\n| mysql-log_mysql_warnings_enabled                                     | false                       |\n| mysql-monitor_enabled                                                | true                        |\n| mysql-monitor_connect_timeout                                        | 600                         |\n| mysql-monitor_ping_max_failures                                      | 3                           |\n| mysql-monitor_ping_timeout                                           | 1000                        |\n| mysql-monitor_read_only_max_timeout_count                            | 3                           |\n| mysql-monitor_replication_lag_interval                               | 10000                       |\n| mysql-monitor_replication_lag_timeout                                | 1000                        |\n| mysql-monitor_replication_lag_count                                  | 1                           |\n| mysql-monitor_groupreplication_healthcheck_interval                  | 5000                        |\n| mysql-monitor_groupreplication_healthcheck_timeout                   | 800                         |\n| mysql-monitor_groupreplication_healthcheck_max_timeout_count         | 3                           |\n| mysql-monitor_groupreplication_max_transactions_behind_count         | 3                           |\n| mysql-monitor_groupreplication_max_transactions_behind_for_read_only | 1                           |\n| mysql-monitor_galera_healthcheck_interval                            | 5000                        |\n| mysql-monitor_galera_healthcheck_timeout                             | 800                         |\n| mysql-monitor_galera_healthcheck_max_timeout_count                   | 3                           |\n| mysql-monitor_replication_lag_use_percona_heartbeat                  |                             |\n| mysql-monitor_query_interval                                         | 60000                       |\n| mysql-monitor_query_timeout                                          | 100                         |\n| mysql-monitor_slave_lag_when_null                                    | 60                          |\n| mysql-monitor_threads_min                                            | 8                           |\n| mysql-monitor_threads_max                                            | 128                         |\n| mysql-monitor_threads_queue_maxsize                                  | 128                         |\n| mysql-monitor_wait_timeout                                           | true                        |\n| mysql-monitor_writer_is_also_reader                                  | true                        |\n| mysql-max_allowed_packet                                             | 67108864                    |\n| mysql-tcp_keepalive_time                                             | 0                           |\n| mysql-use_tcp_keepalive                                              | false                       |\n| mysql-automatic_detect_sqli                                          | false                       |\n| mysql-firewall_whitelist_enabled                                     | false                       |\n| mysql-firewall_whitelist_errormsg                                    | Firewall blocked this query |\n| mysql-throttle_connections_per_sec_to_hostgroup                      | 1000000                     |\n| mysql-max_transaction_idle_time                                      | 14400000                    |\n| mysql-max_transaction_time                                           | 14400000                    |\n| mysql-multiplexing                                                   | true                        |\n| mysql-log_unhealthy_connections                                      | true                        |\n| mysql-enforce_autocommit_on_reads                                    | false                       |\n| mysql-autocommit_false_not_reusable                                  | false                       |\n| mysql-autocommit_false_is_transaction                                | false                       |\n| mysql-verbose_query_error                                            | false                       |\n| mysql-hostgroup_manager_verbose                                      | 1                           |\n| mysql-binlog_reader_connect_retry_msec                               | 3000                        |\n| mysql-threshold_query_length                                         | 524288                      |\n| mysql-threshold_resultset_size                                       | 4194304                     |\n| mysql-query_digests_max_digest_length                                | 2048                        |\n| mysql-query_digests_max_query_length                                 | 65000                       |\n| mysql-query_digests_grouping_limit                                   | 3                           |\n| mysql-wait_timeout                                                   | 28800000                    |\n| mysql-throttle_max_bytes_per_second_to_client                        | 0                           |\n| mysql-throttle_ratio_server_to_client                                | 0                           |\n| mysql-max_stmts_per_connection                                       | 20                          |\n| mysql-max_stmts_cache                                                | 10000                       |\n| mysql-mirror_max_concurrency                                         | 16                          |\n| mysql-mirror_max_queue_length                                        | 32000                       |\n| mysql-default_max_latency_ms                                         | 1000                        |\n| mysql-query_processor_iterations                                     | 0                           |\n| mysql-query_processor_regex                                          | 1                           |\n| mysql-set_query_lock_on_hostgroup                                    | 1                           |\n| mysql-reset_connection_algorithm                                     | 2                           |\n| mysql-auto_increment_delay_multiplex                                 | 5                           |\n| mysql-long_query_time                                                | 1000                        |\n| mysql-query_cache_size_MB                                            | 256                         |\n| mysql-poll_timeout_on_failure                                        | 100                         |\n| mysql-keep_multiplexing_variables                                    | tx_isolation,version        |\n| mysql-kill_backend_connection_when_disconnect                        | true                        |\n| mysql-client_session_track_gtid                                      | true                        |\n| mysql-session_idle_show_processlist                                  | true                        |\n| mysql-show_processlist_extended                                      | 0                           |\n| mysql-query_digests                                                  | true                        |\n| mysql-query_digests_lowercase                                        | false                       |\n| mysql-query_digests_replace_null                                     | false                       |\n| mysql-query_digests_no_digits                                        | false                       |\n| mysql-query_digests_normalize_digest_text                            | false                       |\n| mysql-query_digests_track_hostname                                   | false                       |\n| mysql-servers_stats                                                  | true                        |\n| mysql-default_reconnect                                              | true                        |\n| mysql-ssl_p2s_ca                                                     |                             |\n| mysql-ssl_p2s_capath                                                 |                             |\n| mysql-ssl_p2s_cert                                                   |                             |\n| mysql-ssl_p2s_key                                                    |                             |\n| mysql-ssl_p2s_cipher                                                 |                             |\n| mysql-ssl_p2s_crl                                                    |                             |\n| mysql-ssl_p2s_crlpath                                                |                             |\n| mysql-init_connect                                                   |                             |\n| mysql-ldap_user_variable                                             |                             |\n| mysql-add_ldap_user_comment                                          |                             |\n| mysql-default_tx_isolation                                           | READ-COMMITTED              |\n| mysql-default_session_track_gtids                                    | OFF                         |\n| mysql-connpoll_reset_queue_length                                    | 50                          |\n| mysql-min_num_servers_lantency_awareness                             | 1000                        |\n| mysql-aurora_max_lag_ms_only_read_from_replicas                      | 2                           |\n| mysql-stats_time_backend_query                                       | false                       |\n| mysql-stats_time_query_processor                                     | false                       |\n| mysql-query_cache_stores_empty_result                                | true                        |\n| admin-stats_credentials                                              | stats:stats                 |\n| admin-stats_mysql_connections                                        | 60                          |\n| admin-stats_mysql_connection_pool                                    | 60                          |\n| admin-stats_mysql_query_cache                                        | 60                          |\n| admin-stats_mysql_query_digest_to_disk                               | 0                           |\n| admin-stats_system_cpu                                               | 60                          |\n| admin-stats_system_memory                                            | 60                          |\n| admin-telnet_admin_ifaces                                            | (null)                      |\n| admin-telnet_stats_ifaces                                            | (null)                      |\n| admin-refresh_interval                                               | 2000                        |\n| admin-read_only                                                      | false                       |\n| admin-hash_passwords                                                 | true                        |\n| admin-vacuum_stats                                                   | true                        |\n| admin-version                                                        | 2.3.2-10-g8cd66cf           |\n| admin-cluster_username                                               |                             |\n| admin-cluster_password                                               |                             |\n| admin-cluster_check_interval_ms                                      | 1000                        |\n| admin-cluster_check_status_frequency                                 | 10                          |\n| admin-cluster_mysql_query_rules_diffs_before_sync                    | 3                           |\n| admin-cluster_mysql_servers_diffs_before_sync                        | 3                           |\n| admin-cluster_mysql_users_diffs_before_sync                          | 3                           |\n| admin-cluster_proxysql_servers_diffs_before_sync                     | 3                           |\n| admin-cluster_mysql_variables_diffs_before_sync                      | 3                           |\n| admin-cluster_admin_variables_diffs_before_sync                      | 3                           |\n| admin-cluster_ldap_variables_diffs_before_sync                       | 3                           |\n| admin-cluster_mysql_query_rules_save_to_disk                         | true                        |\n| admin-cluster_mysql_servers_save_to_disk                             | true                        |\n| admin-cluster_mysql_users_save_to_disk                               | true                        |\n| admin-cluster_proxysql_servers_save_to_disk                          | true                        |\n| admin-cluster_mysql_variables_save_to_disk                           | true                        |\n| admin-cluster_admin_variables_save_to_disk                           | true                        |\n| admin-cluster_ldap_variables_save_to_disk                            | true                        |\n| admin-checksum_mysql_query_rules                                     | true                        |\n| admin-checksum_mysql_servers                                         | true                        |\n| admin-checksum_mysql_users                                           | true                        |\n| admin-checksum_mysql_variables                                       | true                        |\n| admin-checksum_admin_variables                                       | true                        |\n| admin-checksum_ldap_variables                                        | true                        |\n| admin-restapi_enabled                                                | false                       |\n| admin-restapi_port                                                   | 6070                        |\n| admin-web_enabled                                                    | false                       |\n| admin-web_port                                                       | 6080                        |\n| admin-web_verbosity                                                  | 0                           |\n| admin-prometheus_memory_metrics_interval                             | 61                          |\n| admin-admin_credentials                                              | admin:admin;radmin:radmin   |\n| admin-mysql_ifaces                                                   | 0.0.0.0:6032                |\n| mysql-threads                                                        | 4                           |\n| mysql-max_connections                                                | 2048                        |\n| mysql-default_query_delay                                            | 0                           |\n| mysql-default_query_timeout                                          | 36000000                    |\n| mysql-have_compress                                                  | true                        |\n| mysql-poll_timeout                                                   | 2000                        |\n| mysql-interfaces                                                     | 0.0.0.0:6033                |\n| mysql-default_schema                                                 | information_schema          |\n| mysql-stacksize                                                      | 1048576                     |\n| mysql-server_version                                                 | 5.5.30                      |\n| mysql-connect_timeout_server                                         | 3000                        |\n| mysql-monitor_username                                               | root                        |\n| mysql-monitor_password                                               | 110022                      |\n| mysql-monitor_history                                                | 600000                      |\n| mysql-monitor_connect_interval                                       | 60000                       |\n| mysql-monitor_ping_interval                                          | 10000                       |\n| mysql-monitor_read_only_interval                                     | 1500                        |\n| mysql-monitor_read_only_timeout                                      | 500                         |\n| mysql-ping_interval_server_msec                                      | 120000                      |\n| mysql-ping_timeout_server                                            | 500                         |\n| mysql-commands_stats                                                 | true                        |\n| mysql-sessions_sort                                                  | true                        |\n| mysql-connect_retries_on_failure                                     | 10                          |\n| mysql-server_capabilities                                            | 569899                      |\n+----------------------------------------------------------------------+-----------------------------+\n\n#\u53c2\u6570\u5f88\u591a\uff0c\u672c\u6b21\u642d\u5efa\u4e3b\u8981\u6539mysql-monitor_username\uff0cmysql-monitor_password\nmysql> UPDATE global_variables SET variable_value='proxysql' where variable_name='mysql-monitor_username';\nQuery OK, 1 row affected (0.01 sec)\n\nmysql> UPDATE global_variables SET variable_value='proxysql' where variable_name='mysql-monitor_password';\nQuery OK, 1 row affected (0.00 sec)\n\n#\u4fee\u6539\u5b8c\u540e\u5e76\u4e0d\u662f\u7acb\u5373\u751f\u6548\u7684\uff0c\u9700\u8981\u624b\u52a8\u52a0\u8f7d\u751f\u6548\uff0c\u5e76\u6301\u4e45\u5316\u5230\u78c1\u76d8\nMySQL [(none)]> LOAD MYSQL VARIABLES TO RUNTIME;\n \nMySQL [(none)]> SAVE MYSQL VARIABLES TO DISK;\n\n#\u914d\u7f6e\u4e1a\u52a1\u767b\u5f55\u8d26\u53f7\uff0c\u4e1a\u52a1\u767b\u5f55\u8d26\u53f7\u9700\u8981mysql\u4e0a\u4e5f\u6709\u8fd9\u4e2a\u8d26\u53f7\uff0c\u914d\u7f6e\u8d26\u53f7\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762myql\u6b65\u9aa4\u8fdb\u884c\u8bbe\u7f6e\n#\u4e5f\u53ef\u4ee5\u8bbe\u7f6e\u5bc6\u7801\u52a0\u5bc6\u3002\u52a0\u5bc6\u63d2\u5165\u8bed\u53e5\u53ef\u4ee5\u53c2\u8003\n\n#StoneDB\u6267\u884c\nSELECT\n   CONCAT(\n       \"insert into mysql_users(username,password,active,default_hostgroup,transaction_persistent) values('\",`User`,\"','\",password,\" ',1,100,1);\")\n   FROM\n       mysql.`user` WHERE `User`='xxxx'\n       \n\nmysql> INSERT INTO MySQL_users(username,password,default_hostgroup) VALUES ('zz','xxxxx',100);\nQuery OK, 1 row affected (0.00 sec)\n\nmysql> LOAD MYSQL SERVERS TO RUNTIME;\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql> SAVE MYSQL SERVERS TO DISK;\nQuery OK, 0 rows affected (0.00 sec)\n\nMySQL [(none)]> LOAD MYSQL USERS TO RUNTIME;\n \nMySQL [(none)]> SAVE MYSQL USERS TO DISK;\n\n")),(0,l.kt)("p",null,"\u914d\u7f6e\u8bfb\u5199\u5206\u79bb\u7ec4\uff0c\u8bbe\u7f6egroup 100\u4e3a\u5199\u7ec4\uff0c200\u4e3a\u8bfb\u7ec4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"mysql> insert into mysql_servers (hostgroup_id, hostname, port) values(100,'192.168.46.10',3306);\nmysql> insert into mysql_servers (hostgroup_id, hostname, port) values(200,'192.168.46.20',3306);\nmysql> LOAD MYSQL SERVERS TO RUNTIME;\nmysql> SAVE MYSQL SERVERS TO DISK;\nmysql> select * from  mysql_servers ;\n+--------------+----------------+-------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+\n| hostgroup_id | hostname       | port  | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |\n+--------------+----------------+-------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+\n| 100          | 192.168.46.10  | 3306  | 0         | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |\n| 200          | 192.168.46.20  | 3306  | 0         | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |\n+--------------+----------------+-------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+\n2 rows in set (0.00 sec)\n\n")),(0,l.kt)("p",null,"\u8bbe\u7f6e\u8bfb\u5199\u5206\u79bb\u89c4\u5219"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"mysql> insert into mysql_query_rules (active, match_pattern, destination_hostgroup, apply) values (1,\"^SELECT\",200,1);\nmysql> insert into mysql_query_rules(active,match_pattern,destination_hostgroup,apply) values(1,'^SELECT.*FOR UPDATE$',100,1);\nmysql> LOAD MYSQL QUERY RULES TO RUNTIME;\nmysql> SAVE MYSQL QUERY RULES TO DISK;\n")),(0,l.kt)("h3",{id:"45\u6d4b\u8bd5\u8bfb\u5199\u5206\u79bb\u89c4\u5219"},"4.5\u6d4b\u8bd5\u8bfb\u5199\u5206\u79bb\u89c4\u5219"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[root@docker ~]# mysql -hxxx.xxx.xxx.xxx -uzz -pxxxxxxx -P6033 -e "select @@hostname"\nWarning: Using a password on the command line interface can be insecure.\n+--------------+\n| @@hostname   |\n+--------------+\n| mysql2       |\n+--------------+\n')),(0,l.kt)("h2",{id:"\u4e94\u6269\u5c55\u77e5\u8bc6"},"\u4e94\u3001\u6269\u5c55\u77e5\u8bc6"),(0,l.kt)("p",null,"\u67e5\u770b\u8bfb\u5199\u5206\u79bbSQL\u6267\u884c\u8bb0\u5f55"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"select hostgroup,username,digest_text,count_star from stats_mysql_query_digest\n")),(0,l.kt)("p",null,"\u6e05\u7406SQL\u6267\u884c\u8bb0\u5f55"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"select * from stats_mysql_query_digest_reset;\n")),(0,l.kt)("p",null,"\u8bbe\u7f6e\u9ad8\u53ef\u7528\u8bfb\u5199\u5206\u79bb\u5207\u6362"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"mysql> insert into  mysql_replication_hostgroups (writer_hostgroup,reader_hostgroup,comment)values(100,200,'\u6d4b\u8bd5\u6211\u7684\u8bfb\u5199\u5206\u79bb\u9ad8\u53ef\u7528');\nmysql> load mysql servers to runtime;\nQuery OK, 0 rows affected (0.01 sec)\nmysql> save mysql servers to disk;\nQuery OK, 0 rows affected (0.03 sec)\nmysql> select * from runtime_mysql_replication_hostgroups;\n+------------------+------------------+-----------------------------------+\n| writer_hostgroup | reader_hostgroup | comment                           |\n+------------------+------------------+-----------------------------------+\n| 100              | 1000             | \u6d4b\u8bd5\u6211\u7684\u8bfb\u5199\u5206\u79bb\u9ad8\u53ef\u7528            |\n+------------------+------------------+-----------------------------------+\n1 row in set (0.00 sec)\n")))}c.isMDXComponent=!0},55419:function(e,n,s){n.Z=s.p+"assets/images/ProxySQL-7f06c582611775b7e80bde3b289a0ede.png"}}]);