<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-about-stonedb/architecture">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/zh/community/rss.xml" title="StoneDB RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/community/atom.xml" title="StoneDB Atom Feed">
<link rel="icon" href="/zh/img/stoneDB.png">
<link rel="manifest" href="/zh/manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/zh/img/stoneDB.png">
<link rel="mask-icon" href="/zh/img/stoneDB.png" color="rgb(62, 204, 94)">
<meta name="msapplication-TileImage" content="/zh/img/stoneDB.png">
<meta name="msapplication-TileColor" content="#000"><title data-rh="true">整体架构 | StoneDB</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://stonedb.io/zh/docs/about-stonedb/architecture"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="整体架构 | StoneDB"><meta data-rh="true" name="description" content="image.png"><meta data-rh="true" property="og:description" content="image.png"><link data-rh="true" rel="icon" href="/zh/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://stonedb.io/zh/docs/about-stonedb/architecture"><link data-rh="true" rel="alternate" href="https://stonedb.io/docs/about-stonedb/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://stonedb.io/zh/docs/about-stonedb/architecture" hreflang="zh"><link data-rh="true" rel="alternate" href="https://stonedb.io/docs/about-stonedb/architecture" hreflang="x-default"><link rel="stylesheet" href="/zh/assets/css/styles.cee48ecd.css">
<link rel="preload" href="/zh/assets/js/runtime~main.519e7d93.js" as="script">
<link rel="preload" href="/zh/assets/js/main.31af919d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/zh/"><div class="navbar__logo"><img src="/zh/img/logo_stonedb.svg" alt="StoneDB" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh/img/logo_stonedb.svg" alt="StoneDB" class="themedImage_ToTc themedImage--dark_i4oU"></div><span class="navbar__title text--truncate">首页</span></a><a class="navbar__item navbar__link" href="/zh/docs/download">下载</a><a class="navbar__item navbar__link" href="/zh/docs/about-stonedb/intro">文档</a><a class="navbar__item navbar__link" href="/zh/community/main">社区</a></div><div class="navbar__items navbar__items--right"><div class="ant-space ant-space-horizontal ant-space-align-center styles__GithubStyle-sc-gz8zhn-0 fMOuum hideInMobile"><div class="ant-space-item" style="margin-right:8px"></div><div class="ant-space-item"></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><span role="img" class="anticon undefined icon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><use xlink:href="#icon-a-bianzu9"></use></svg></span>简体中文</a><ul class="dropdown__menu"><li><a href="/docs/about-stonedb/architecture" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/zh/docs/about-stonedb/architecture" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">简体中文</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" target="_self" href="/zh/"><img src="/zh/img/logo_stonedb.svg" alt="StoneDB" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh/img/logo_stonedb.svg" alt="StoneDB" class="themedImage_ToTc themedImage--dark_i4oU"><span>首页</span></a><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/zh/docs/about-stonedb/intro">关于StoneDB</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/about-stonedb/intro">StoneDB 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zh/docs/about-stonedb/architecture">整体架构</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/about-stonedb/limits">使用限制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/about-stonedb/terms">常见术语介绍</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/environment-requirements/supported-servers-and-OSs">环境要求</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/getting-started/quick-deployment">快速上手</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/O&amp;M-Guide/regular-change-operations">运维管理</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/compiling-methods">开发者指南</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/SQL-reference/character-sets">SQL 参考</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/performance-tuning/overview">性能优化</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/data-migration-to-stonedb/use-outter-to-migrate">向StoneDB迁移数据</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/troubleshooting/failed-to-start">故障诊断</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/FAQ/install-faq">FAQ</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/docs/release-notes">Release Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/docs/download">立即下载</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/zh/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">关于StoneDB</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">整体架构</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>整体架构</h1><p><img loading="lazy" alt="image.png" src="/zh/assets/images/stonedb-architecture-V1-cc5186dede7f33f3e6e7d6fe5a65ca5b.png" width="634" height="588"></p><p>StoneDB是一个HTAP数据库，其存储引擎stonedb是一个高性能、高压缩比的列式存储引擎，适用于OLAP应用。和其他的存储引擎如InnoDB、MyISAM一样，stonedb提供了存储引擎所具有的一切功能。从架构上可以看出，逻辑上分为应用层、服务层和存储引擎层。在StoneDB中，一个SQL从发起到最终返回结果，会经历每个逻辑层的不同组件。</p><h1>应用层</h1><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="连接管理">连接管理<a class="hash-link" href="#连接管理" title="标题的直接链接">​</a></h2><p>当客户端向服务端发起连接请求后，服务端会从线程池中分配一个线程，这个线程专门负责和这个客户端进行交互。如果客户端断开连接，这个线程也不会被立即销毁，而是被线程池回收，重新分配给新的连接，减少了创建线程和释放线程所花费的时间。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="用户鉴权">用户鉴权<a class="hash-link" href="#用户鉴权" title="标题的直接链接">​</a></h2><p>当客户端连接服务端后，服务端会对发起连接的用户进行鉴权处理，鉴权的依据是检查用户名、密码、IP地址及端口是否正确。如果鉴权失败，则拒绝连接。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="安全管理">安全管理<a class="hash-link" href="#安全管理" title="标题的直接链接">​</a></h2><p>当客户端成功连接服务端后，服务端会从权限表里根据用户的权限来判断用户具体可执行哪些操作。</p><h1>服务层</h1><p>服务层提供了数据库的逻辑功能，StoneDB会使用服务层的相关组件，如系统管理、SQL接口、查询缓存、SQL解析器。<br>注：StoneDB有自己的优化器和执行器，这里不对MySQL的优化器和执行器做介绍。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="management--utilities">Management &amp; Utilities<a class="hash-link" href="#management--utilities" title="标题的直接链接">​</a></h2><p>系统管理的主要作用是提供了丰富的数据库管理功能，如备份与恢复、用户及权限管理、数据库元数据管理等。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sql-interface">SQL Interface<a class="hash-link" href="#sql-interface" title="标题的直接链接">​</a></h2><p>SQL接口的主要作用是接收用户的SQL并进行处理，得到用户所需要的结果。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="caches--buffers">Caches &amp; buffers<a class="hash-link" href="#caches--buffers" title="标题的直接链接">​</a></h2><p>查询缓存主要缓存的是SQL语句的hash值和结果集，目的是提高执行效率。当一个SQL被发起，首先会经过hash运算，如果在查询缓存命中，则直接返回，无须再通过解析、优化和执行等阶段，如果在查询缓存不能命中，则需要解析、优化和执行等阶段。然而只要表结构有变更或者表数据有更新，查询缓存就会失效。因此，生产环境建议关闭查询缓存，到了MySQL 8.0已经废弃了查询缓存功能。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="parser">Parser<a class="hash-link" href="#parser" title="标题的直接链接">​</a></h2><p>解析器的主要作用是解析SQL语句，最终生成解析树。解析器会对SQL语句进行词法解析（表、列是否存在）和语法解析（SQL语法是否正确），如果有错误，则返回相应的错误信息。</p><h1>存储引擎层</h1><p>StoneDB的存储引擎层包括数据解压缩模块、优化器、知识网格等。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="stonedb-optimizer">StoneDB Optimizer<a class="hash-link" href="#stonedb-optimizer" title="标题的直接链接">​</a></h2><p>StoneDB有自己的优化器，优化器会对SQL语句进行优化，如表达式转化、子查询转连接等，然后基于知识网格技术生成一个高效的执行计划。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="stonedb-executor">StoneDB Executor<a class="hash-link" href="#stonedb-executor" title="标题的直接链接">​</a></h2><p>根据优化器产生的执行计划读取数据。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="knowledge-grid-manager">Knowledge Grid Manager<a class="hash-link" href="#knowledge-grid-manager" title="标题的直接链接">​</a></h2><p>当数据量达到千万、亿级的时候，在做统计分析执行聚合查询的时候，原生MySQL或其它关系型数据库可能需要几分钟到几十分钟左右才能得到结果集。而StoneDB在同等的数据量和查询语句条件下，比原生MySQL或其它关系型数据库要快数十倍。主要是得益于它的列式存储、数据压缩和知识网格技术。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="data-pack">Data Pack<a class="hash-link" href="#data-pack" title="标题的直接链接">​</a></h3><p>数据包用于存放实际数据，是最底层的数据存储单元，每列按照65536行切分成一个数据包。每个数据包比列更小，具有更高的压缩比，而每个数据包又比每行更大，具有更好的查询性能。数据包也是知识网格的解压缩单元。</p><p>根据粗糙集的概念，数据包分为以下几类：</p><ol><li><p>不相关的数据包：不满足查询条件的数据包</p></li><li><p>相关的数据包：满足查询条件的数据包</p></li><li><p>可疑的数据包：数据包中的数据部分满足查询条件，需要进一步解压缩数据包才能得到满足条件的数据行</p></li></ol><p>通过对数据包的划分，知识网格技术过滤掉不相关的数据包，读取相关的数据包和可疑的数据包。其中相关的数据包不需要解压缩，只读取元数据，不会发生IO，可疑的数据包需要解压缩，会发生IO。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="data-pack-node">Data Pack Node<a class="hash-link" href="#data-pack-node" title="标题的直接链接">​</a></h3><p>数据包节点也称为元数据节点（Metadata Node），因为数据包节点记录了每个数据包中列的最大值、最小值、平均值、总和、总记录数、null值的数量、压缩方式、占用的字节数。每一个数据包节点对应一个数据包。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="knowledge-node">Knowledge Node<a class="hash-link" href="#knowledge-node" title="标题的直接链接">​</a></h3><p>数据包节点的上一层是知识节点，记录了数据包之间或者列之间关系的元数据集合，比如值数据包的最小值与最大值的范围、列之间的关联关系。大部分的知识节点数据是装载数据的时候产生的，另外一部分是查询的时候产生的。</p><p>知识节点的3种基本类型：</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-histogram">1. Histogram<a class="hash-link" href="#1-histogram" title="标题的直接链接">​</a></h4><p>数据类型为整型、日期型、浮点型的列的统计信息以直方图的形式存在。将一个数据包的最小值到最大值之间分为1024段，每段占用一个bit，如果数据包中的实际值处于段中的范围，则标记为1，否则标记为0。数据被加载时，Histogram被自动创建。</p><p>如下的例子中，说明数据包中有值落在0~100和102301~102400两个区间。</p><table><thead><tr><th>0‒100</th><th>101‒200</th><th>201‒300</th><th>...</th><th>102301‒102400</th></tr></thead><tbody><tr><td>1</td><td>0</td><td>0</td><td>...</td><td>1</td></tr></tbody></table><p>如果想要执行以下SQL：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token number" style="color:rgb(247, 140, 108)">199</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> id</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">299</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过直方图可知，这个查询没有在这个数据包命中，即当前数据包不满足查询条件，这个数据包直接被丢弃。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-character-map">2. Character Map<a class="hash-link" href="#2-character-map" title="标题的直接链接">​</a></h4><p>数据类型为字符串的列的字符映射表。将字符串按照字符拆分，统计一个数据包内1~64长度中ASCII字符是否存在。如果存在，则标记为1，否则标记为0。数据被加载时，Character Map被自动创建。<br>如下的例子中，说明A在字符串的第1个和第64个位置存在。</p><table><thead><tr><th>Char/Char pos</th><th>1</th><th>2</th><th>...</th><th>64</th></tr></thead><tbody><tr><td>A</td><td>1</td><td>0</td><td>...</td><td>1</td></tr><tr><td>B</td><td>0</td><td>1</td><td>...</td><td>0</td></tr><tr><td>C</td><td>1</td><td>1</td><td>...</td><td>1</td></tr><tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-pack-to-pack">3. Pack to Pack<a class="hash-link" href="#3-pack-to-pack" title="标题的直接链接">​</a></h4><p>包对包关系表示不同表的两个列之间的等值映射表，并以二进制矩阵的形式进行存储，如果符合表关联条件，则标记为1，否则标记为0。包对包关系能帮助在表关联查询的时候快速判断出符合查询条件的数据包，从而提升表关联查询的效率。表关联查询时，Pack to Pack被自动创建。<br>如下的例子中，表关联的查询条件是&quot;A.C=B.D&quot;，在A.C1这个数据包中，只有B.D2和B.D5这两个数据包中有符合表关联条件的值。</p><table><thead><tr><th></th><th>B.D1</th><th>B.D2</th><th>B.D3</th><th>B.D4</th><th>B.D5</th></tr></thead><tbody><tr><td>A.C1</td><td>0</td><td>1</td><td>0</td><td>0</td><td>1</td></tr><tr><td>A.C2</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td></tr><tr><td>A.C3</td><td>1</td><td>1</td><td>0</td><td>1</td><td>1</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="knowledge-grid">Knowledge Grid<a class="hash-link" href="#knowledge-grid" title="标题的直接链接">​</a></h3><p>知识网格是由数据包节点和知识节点组成的。由于数据包都是压缩存放的，所以数据读取解压的代价比较高，在查询中如何做到读取尽量少的数据包是提升效率的关键。知识网格正是起到了这样的一个作用，它能够有效的过滤查询中不符合条件的数据，以最小的代价定位以数据包为最小单位的数据。知识网格的数据大小只占数据总量的1%以下，通常情况下可以加载到内存中，进一步提升查询效率。</p><p>对于大部分统计、聚合性查询，StoneDB往往只需要使用知识网格就能返回查询结果，这是因为通过知识网格可以消除或大量减少需要解压的数据包，降低IO消耗，提高查询响应时间和网络利用率。例如：数据包节点记录了最大值、最小值、平均值、总和、总记录数、null值的数量，如果想对某个列做聚合运算，那么知识网格就能根据这些元数据很快的得到结果，而无需再解压访问底层的数据包。</p><p><strong>通过一个例子来理解一个查询语句在存储引擎层使用知识网格技术的查询优化过程。</strong></p><p>有如下的查询语句和数据包节点的数据值分布范围。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">min</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">t2 </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">B</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">t2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">C </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">A</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token number" style="color:rgb(247, 140, 108)">15</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th></th><th>Min.</th><th>Max.</th></tr></thead><tbody><tr><td>t1.A1</td><td>1</td><td>9</td></tr><tr><td>t1.A2</td><td>10</td><td>30</td></tr><tr><td>t1.A3</td><td>40</td><td>100</td></tr></tbody></table><p>根据列A的DPN可知，t1.A1属于不相关的数据包，t1.A2属于可疑的数据包，t1.A3属于相关的数据包，这一步就过滤掉数据包t1.A1。</p><table><thead><tr><th></th><th>t2.C1</th><th>t2.C2</th><th>t2.C3</th><th>t2.C4</th><th>t2.C5</th></tr></thead><tbody><tr><td>t1.B1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>1</td></tr><tr><td>t1.B2</td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td></tr><tr><td>t1.B3</td><td>1</td><td>1</td><td>0</td><td>0</td><td>1</td></tr></tbody></table><p>第一步已经过滤掉数据包t1.A1，这一步就不需要对t1.B1和t2.C1做关联对比，根据包对包关系的映射表可知，这一步过滤掉数据包t2.C3和t2.C4。</p><p>那么满足关联条件的数据包有t2.C2和t2.C5。</p><table><thead><tr><th></th><th>Min.</th><th>Max.</th></tr></thead><tbody><tr><td>t2.D1</td><td>0</td><td>500</td></tr><tr><td>t2.D2</td><td>101</td><td>440</td></tr><tr><td>t2.D3</td><td>300</td><td>6879</td></tr><tr><td>t2.D4</td><td>1</td><td>432</td></tr><tr><td>t2.D5</td><td>3</td><td>100</td></tr></tbody></table><p>第一步和第二步已经过滤掉D1、D3、D4，那么只剩下D2和D5，根据列D的DPN可知，D5的最大值100小于D2的最小值101，这一步过滤掉数据包D2。最后只剩下数据包D5，只需要对数据包D5进行解压缩就能得到最终的结果。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="stonedb-loader-parser">StoneDB Loader Parser<a class="hash-link" href="#stonedb-loader-parser" title="标题的直接链接">​</a></h2><p>数据导入导出模块，即处理 LOAD DATA INFILE 与 SELECT … INTO FILE 任务。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="insert-buffer">Insert Buffer<a class="hash-link" href="#insert-buffer" title="标题的直接链接">​</a></h2><p>StoneDB的 Insert Buffer 是为整张表的插入做的优化设计，当向表插入数据时，数据先暂存到 Insert Buffer，然后再从 Insert Buffer 批量刷新到磁盘，从系统的表现来看是吞吐量提高了。如果不经过 Insert Buffer，而是直接写入磁盘，由于StoneDB不支持事务，只能一行接着一行往磁盘写入，系统的吞吐量是不高的，插入效率固然不高。Insert Buffer 由参数stonedb_insert_delayed控制，默认为on表示开启。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="replication-manager">Replication Manager<a class="hash-link" href="#replication-manager" title="标题的直接链接">​</a></h2><p>StoneDB复制管理模块，与MySQL的主从复制架构类似，StoneDB为了保证数据的一致性，会在Master上执行写操作，然后通过复制技术传输到Slave。与MySQL不同的是StoneDB存储引擎存储的不是原始数据，而是压缩后的数据。如果使用binlog的方式来复制，会导致网络上产生大量数据流量，为了解决这个问题，StoneDB实现了基于压缩后数据包的高效数据复制支持，相对于binlog复制，该技术可以大大降低网络传输所需的数据量。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="compress">Compress<a class="hash-link" href="#compress" title="标题的直接链接">​</a></h2><p>数据压缩模块，在StoneDB中，数据是按照列模式进行组织的，这种数据组织形式对各类压缩算法十分友好，可依据数据类型选择合适的高效压缩算法。StoneDB可以支持多达20多种自适应压缩算法，目前主要使用的有PPM、LZ4、B2、Delta等。如果列的重复值越高，压缩效果越好。数据压缩后，不仅可以节约存储成本，还可以节约IO和内存。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="decompress">Decompress<a class="hash-link" href="#decompress" title="标题的直接链接">​</a></h2><p>数据解压缩模块，数据压缩和解压缩的单位是数据包。知识网格技术过滤掉不相关的数据包后，对可疑的数据包需要解压缩才能得到符合查询的结果集。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/stoneatom/stonedb/edit/stonedb-5.7/website/i18n/zh/docusaurus-plugin-content-docs/current/00-about-stonedb/architecture.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vbeJ"><span class="theme-last-updated">最后<!-- -->由 <b>xiaoguangye</b> <!-- -->于 <b><time datetime="2022-08-07T11:44:39.000Z">2022/8/7</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/docs/about-stonedb/intro"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">StoneDB 简介</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/docs/about-stonedb/limits"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">使用限制</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#连接管理" class="table-of-contents__link toc-highlight">连接管理</a></li><li><a href="#用户鉴权" class="table-of-contents__link toc-highlight">用户鉴权</a></li><li><a href="#安全管理" class="table-of-contents__link toc-highlight">安全管理</a></li><li><a href="#management--utilities" class="table-of-contents__link toc-highlight">Management &amp; Utilities</a></li><li><a href="#sql-interface" class="table-of-contents__link toc-highlight">SQL Interface</a></li><li><a href="#caches--buffers" class="table-of-contents__link toc-highlight">Caches &amp; buffers</a></li><li><a href="#parser" class="table-of-contents__link toc-highlight">Parser</a></li><li><a href="#stonedb-optimizer" class="table-of-contents__link toc-highlight">StoneDB Optimizer</a></li><li><a href="#stonedb-executor" class="table-of-contents__link toc-highlight">StoneDB Executor</a></li><li><a href="#knowledge-grid-manager" class="table-of-contents__link toc-highlight">Knowledge Grid Manager</a><ul><li><a href="#data-pack" class="table-of-contents__link toc-highlight">Data Pack</a></li><li><a href="#data-pack-node" class="table-of-contents__link toc-highlight">Data Pack Node</a></li><li><a href="#knowledge-node" class="table-of-contents__link toc-highlight">Knowledge Node</a></li><li><a href="#knowledge-grid" class="table-of-contents__link toc-highlight">Knowledge Grid</a></li></ul></li><li><a href="#stonedb-loader-parser" class="table-of-contents__link toc-highlight">StoneDB Loader Parser</a></li><li><a href="#insert-buffer" class="table-of-contents__link toc-highlight">Insert Buffer</a></li><li><a href="#replication-manager" class="table-of-contents__link toc-highlight">Replication Manager</a></li><li><a href="#compress" class="table-of-contents__link toc-highlight">Compress</a></li><li><a href="#decompress" class="table-of-contents__link toc-highlight">Decompress</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><div class="styles__LinkItemStyle-sc-1h1kjiy-0 hDEIGG"><a href="https://twitter.com/StoneDataBase" target="_blank" rel="noopener noreferrer" class="styles__Link-sc-1h1kjiy-1 jSEJvj"><span role="img" class="anticon undefined icon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><use xlink:href="#icon-a-bianzu2"></use></svg></span></a></div><span class="footer__link-separator">·</span><div class="styles__LinkItemStyle-sc-1h1kjiy-0 hDEIGG"><a class="styles__Link-sc-1h1kjiy-1 jSEJvj"><span role="img" class="anticon undefined icon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><use xlink:href="#icon-a-bianzu17beifen2"></use></svg></span></a></div><span class="footer__link-separator">·</span><div class="styles__LinkItemStyle-sc-1h1kjiy-0 hDEIGG"><a href="https://stonedb.slack.com/join/shared_invite/zt-1ba2lpvbo-Vqq62DJcxViyxCZmp7Rimw#/shared-invite/email" target="_blank" rel="noopener noreferrer" class="styles__Link-sc-1h1kjiy-1 jSEJvj"><span role="img" class="anticon undefined icon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><use xlink:href="#icon-a-bianzu18beifen2"></use></svg></span></a></div><span class="footer__link-separator">·</span><div class="styles__LinkItemStyle-sc-1h1kjiy-0 hDEIGG"><a href="https://github.com/StoneAtom/stonedb" target="_blank" rel="noopener noreferrer" class="styles__Link-sc-1h1kjiy-1 jSEJvj"><span role="img" class="anticon undefined icon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><use xlink:href="#icon-a-bianzu4"></use></svg></span></a></div></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © The StoneAtom-tech ALL Rights Reserved</div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.519e7d93.js"></script>
<script src="/zh/assets/js/main.31af919d.js"></script>
</body>
</html>